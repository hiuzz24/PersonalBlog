<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .user-card {
            display: flex;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #ddd;
        }

        .user-card img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 10px;
        }

        .user-card .user-info {
            flex-grow: 1;
        }

        .user-card .btn {
            margin-left: 10px;
        }
    </style>
</head>
<body>
<div class="container mt-5">
    <h2>User Dashboard</h2>
    <ul class="nav nav-tabs">
        <li class="nav-item">
            <a class="nav-link active" data-bs-toggle="tab" href="#followers">Followers</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" data-bs-toggle="tab" href="#following">Following</a>
        </li>
    </ul>
    <div class="tab-content mt-3">
        <div class="tab-pane fade show active" id="followers">
            <h3>Followers</h3>
            <div id="followers-list"></div>
        </div>
        <div class="tab-pane fade" id="following">
            <h3>Following</h3>
            <div id="following-list"></div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    function showToast(message, type) {
        // Implement toast notification (e.g., using Bootstrap toast)
        const toastContainer = document.createElement('div');
        toastContainer.className = `toast align-items-center text-white bg-${type === 'success' ? 'success' : 'danger'} border-0`;
        toastContainer.role = 'alert';
        toastContainer.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">${message}</div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            `;
        document.body.appendChild(toastContainer);
        const toast = new bootstrap.Toast(toastContainer);
        toast.show();
        setTimeout(() => toastContainer.remove(), 3000);
    }

    function renderUserList(users, containerId, isFollowing) {
        const container = document.getElementById(containerId);
        container.innerHTML = '';
        users.forEach(user => {
            const userCard = document.createElement('div');
            userCard.className = 'user-card';
            userCard.innerHTML = `
                    <img src="${user.avatarUrl || 'https://via.placeholder.com/40'}" alt="Avatar">
                    <div class="user-info">
                        <strong>${user.username}</strong>
                        <p>${user.fullName || ''}</p>
                    </div>
                    <button class="btn ${isFollowing ? 'btn-primary' : 'btn-outline-primary'}" data-user-id="${user.userId}">
                        <i class="bi ${isFollowing ? 'bi-person-check-fill' : 'bi-person-plus'}"></i>
                        <span>${isFollowing ? 'Following' : 'Follow'}</span>
                    </button>
                `;
            container.appendChild(userCard);

            const button = userCard.querySelector('button');
            button.addEventListener('click', () => {
                const url = isFollowing ? `/api/follows/unfollow/${user.userId}` : `/api/follows/follow/${user.userId}`;
                fetch(url, {
                    method: isFollowing ? 'DELETE' : 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    credentials: 'same-origin'
                })
                    .then(response => {
                        if (!response.ok) {
                            return response.json().then(errorData => {
                                throw new Error(errorData.message || 'Network response was not ok');
                            });
                        }
                        return response.json();
                    })
                    .then(data => {
                        showToast(data.message || 'Operation successful', 'success');
                        // Reload danh sách sau khi follow/unfollow
                        loadDashboardData();
                    })
                    .catch(error => {
                        showToast(error.message || 'An error occurred. Try again later', 'error');
                    });
            });
        });
    }

    function loadDashboardData() {
        // Load followers
        fetch('/api/follows/followers', {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            credentials: 'same-origin'
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    renderUserList(data.followers, 'followers-list', false);
                } else {
                    showToast(data.message || 'Failed to load followers', 'error');
                }
            })
            .catch(error => {
                showToast('An error occurred while loading followers', 'error');
            });

        // Load following
        fetch('/api/follows/following', {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            credentials: 'same-origin'
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    renderUserList(data.following, 'following-list', true);
                } else {
                    showToast(data.message || 'Failed to load following', 'error');
                }
            })
            .catch(error => {
                showToast('An error occurred while loading following', 'error');
            });
    }

    // Load data khi trang được tải
    document.addEventListener('DOMContentLoaded', loadDashboardData);
</script>
</body>
</html>