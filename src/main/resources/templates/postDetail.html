<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">

<head>
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>Single Post - PersonalBlog Bootstrap Template</title>
    <meta name="description" content="">
    <meta name="keywords" content="">

    <!-- Favicons -->
    <link th:href="@{/assets/img/favicon.png}" rel="icon">
    <link th:href="@{/assets/img/apple-touch-icon.png}" rel="apple-touch-icon">

    <!-- Fonts -->
    <link th:href="@{https://fonts.googleapis.com}" rel="preconnect">
    <link th:href="@{https://fonts.gstatic.com}" rel="preconnect" crossorigin>
    <link th:href="@{https://fonts.googleapis.com/css2?family=Inter:wght@100;200;300;400;500;600;700;800;900&family=EB+Garamond:ital,wght@0,400;0,500;0,600;0,700;0,800;1,400;1,500;1,600;1,700;1,800&display=swap}"
          rel="stylesheet">

    <!-- Vendor CSS Files -->
    <link th:href="@{/assets/vendor/bootstrap/css/bootstrap.min.css}" rel="stylesheet">
    <link th:href="@{/assets/vendor/bootstrap-icons/bootstrap-icons.css}" rel="stylesheet">
    <link th:href="@{/assets/vendor/aos/aos.css}" rel="stylesheet">
    <link th:href="@{/assets/vendor/swiper/swiper-bundle.min.css}" rel="stylesheet">

    <!-- Main CSS File -->
    <link th:href="@{/assets/css/main.css}" rel="stylesheet">

    <!-- =======================================================
    * Template Name: ZenBlog
    * Template URL: https://bootstrapmade.com/zenblog-bootstrap-blog-template/
    * Updated: Aug 08 2024 with Bootstrap v5.3.3
    * Author: BootstrapMade.com
    * License: https://bootstrapmade.com/license/
    ======================================================== -->
</head>

<body class="single-post-page">

<header id="header" class="header d-flex align-items-center sticky-top">
    <div class="container position-relative d-flex align-items-center justify-content-between">

        <a th:href="@{/}" class="logo d-flex align-items-center me-auto me-xl-0">
            <h1 class="sitename">PersonalBlog</h1>
        </a>

        <nav id="navmenu" class="navmenu">
            <ul>
                <li><a th:href="@{/}">Home</a></li>
                <li><a href="about.html">About</a></li>
                <li class="dropdown"><a href="#"><span>Categories</span> <i
                        class="bi bi-chevron-down toggle-dropdown"></i></a>
                    <ul>
                        <li><a href="category.html">Category 1</a></li>
                        <li class="dropdown"><a href="#"><span>Deep Dropdown</span> <i class="bi bi-chevron-down toggle-dropdown"></i></a>
                            <ul>
                                <li><a href="#">Deep Dropdown 1</a></li>
                                <li><a href="#">Deep Dropdown 2</a></li>
                                <li><a href="#">Deep Dropdown 3</a></li>
                                <li><a href="#">Deep Dropdown 4</a></li>
                                <li><a href="#">Deep Dropdown 5</a></li>
                            </ul>
                        </li>
                        <li><a href="category.html">Category 2</a></li>
                        <li><a href="category.html">Category 3</a></li>
                        <li><a href="category.html">Category 4</a></li>
                    </ul>
                </li>
                <li><a href="contact.html">Contact</a></li>
            </ul>
            <i class="mobile-nav-toggle d-xl-none bi bi-list"></i>
        </nav>

        <div class="header-social-links">
            <div class="dropdown">
                <a href="#" class="d-flex align-items-center" id="userDropdown" data-bs-toggle="dropdown"
                   aria-expanded="false" style="padding:0; border:none; background:none;">
                    <img th:src="${user != null && user.avatarUrl != null && !#strings.isEmpty(user.avatarUrl) ? user.avatarUrl : '/assets/img/user.png'}"
                         alt="avatar" style="width:36px; height:36px; border-radius:50%; object-fit:cover;">
                </a>
                <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
                    <li>
                        <form th:action="@{/profile}" method="get" style="display: inline;">
                            <button type="submit" class="dropdown-item">Profile</button>
                        </form>
                    </li>

                    <li>
                        <hr class="dropdown-divider">
                    </li>
                    <li>
                        <form th:action="@{/logout}" method="post" style="display: inline;">
                            <button type="submit" class="dropdown-item">Logout</button>
                        </form>
                    </li>
                </ul>
            </div>
        </div>

    </div>
</header>

<main class="main">

    <!-- Page Title -->
    <div class="page-title">
        <div class="container d-lg-flex justify-content-between align-items-center">
            <h1 class="mb-2 mb-lg-0">Single Post</h1>
            <nav class="breadcrumbs">
                <ol>
                    <li><a th:href="@{/}">Home</a></li>
                    <li class="current">Single Post</li>
                </ol>
            </nav>
        </div>
    </div><!-- End Page Title -->

    <div class="container">
        <div class="row">

            <div class="col-lg-8">

                <!-- Blog Details Section -->
                <section id="blog-details" class="blog-details section">
                    <div class="container">

                        <article class="article">

                            <div class="post-img">
                                <img th:src="${postDetail.imageUrl}" alt="" class="img-fluid">
                            </div>

                            <h2 class="title" th:text="${postDetail.title}"></h2>

                            <div class="meta-top">
                                <ul>
                                    <li class="d-flex align-items-center"><i class="bi bi-person"
                                                                             th:text="${postDetail.users.fullName}"></i>
                                    </li>
                                    <li class="d-flex align-items-center"><i class="bi bi-clock"></i> <a
                                            href="blog-details.html">
                                        <time th:text="${postDetail.publishedAt}"></time>
                                    </a></li>
                                    <li class="d-flex align-items-center"><i class="bi bi-chat-dots"
                                                                             th:text="${' ' + postDetail.comments.size() + ' comments'}"></i></a>
                                    </li>
                                </ul>
                            </div><!-- End meta top -->

                            <div class="content" th:utext="${postDetail.body}">

                            </div><!-- End post content -->

                            <div class="meta-bottom">
                                <i class="bi bi-tags"></i>
                                <ul class="tags" th:each="tag: ${postDetail.tags}">
                                    <li><a th:href="@{/tags/{tagID}(tagID = ${tag.tagName})}"
                                           th:text="${tag.tagName}"></a></li>
                                </ul>
                            </div><!-- End meta bottom -->

                            <!-- Favorite Button -->
                            <div class="mt-3 mb-3">
                                <button type="button" class="btn btn-outline-danger" id="favoriteBtn"
                                        th:data-post-id="${postDetail.postID}"
                                        th:classappend="${isFavorited} ? 'btn-danger' : 'btn-outline-danger'">
                                    <i class="bi" th:classappend="${isFavorited} ? 'bi-heart-fill' : 'bi-heart'"></i>
                                    <span th:text="${isFavorited} ? 'Đã lưu' : 'Lưu bài viết'"></span>
                                </button>
                            </div>

                            <!-- Chat with Author Button (only show if not the author) -->
                            <div th:if="${#authentication.name != postDetail.users.username}" class="mt-4">
                                <button type="button" class="btn btn-primary" id="chatWithAuthorBtn"
                                        th:data-author-id="${postDetail.users.userID}"
                                        th:data-author-name="${postDetail.users.fullName != null ? postDetail.users.fullName : postDetail.users.username}">
                                    <i class="bi bi-chat-dots"></i> Chat with the author
                                </button>
                            </div>


                        </article>

                    </div>
                </section><!-- /Blog Details Section -->

                <!-- Blog Comments Section -->
                <section id="blog-comments" class="blog-comments section">

                    <div class="container">

                        <h4 class="comments-count" th:text="${countComment} +' comments'"></h4>

                        <ol class="comment-list">
                            <li class="comment" th:each="parent : ${comments}">
                                <div class="comment-body">
                                    <div class="comment-author vcard">
                                        <img class="avatar photo" src="assets/img/blog/comments-1.jpg" alt="">
                                        <cite class="fn" th:text="${parent.user.username}"></cite>
                                        <span class="says">says:</span>
                                    </div>
                                    <div class="comment-meta">
                                        <a href="#" th:text="${parent.createdAt}">Date</a>
                                    </div>
                                    <p th:text="${parent.content}">Comment content</p>
                                    <div class="reply">
                                        <a href="#" class="comment-reply-link" onclick="toggleReplyBox(event, this)">Reply</a>
                                    </div>

                                    <form action="/comments/add" method="post">
                                        <div class="reply-box"
                                             style="display: none; margin-top: 10px; margin-bottom : 10px">
                                            <input type="hidden" name="parentId" th:value="${parent.commentId}">
                                            <input type="hidden" name="post.postID" th:value="${post.postID}">
                                            <textarea placeholder="Enter your reply..." rows="3"
                                                      name="content" class="form-control" required></textarea>
                                            <button type="submit" class="btn btn-primary btn-sm mt-2">Submit Reply</button>
                                        </div>
                                    </form>
                                </div>
                                <ol class="children" th:if="${parent.children != null and !parent.children.empty}">
                                    <div th:replace="~{comment-recursive :: commentList(childComments=${parent.children})}"></div>
                                </ol>
                            </li>
                        </ol>
                    </div>

                    <script>
                        function toggleReplyBox(event, element) {
                            event.preventDefault(); // Chặn hành vi mặc định của thẻ <a>

                            // Tìm phần tử cha gần nhất có class .comment
                            let commentContainer = element.closest('.comment');

                            // Tìm phần tử .reply-box bên trong comment đó
                            let replyBox = commentContainer.querySelector('.reply-box');

                            // Hiển thị hoặc ẩn phần nhập comment
                            if (replyBox.style.display === "none") {
                                replyBox.style.display = "block";
                            } else {
                                replyBox.style.display = "none";
                            }
                        }
                    </script>

                </section><!-- /Blog Comments Section -->

                <!-- Comment Form Section -->
                <section id="comment-form" class="comment-form section">
                    <div class="container">

                        <!-- Flash Messages -->
                        <div th:if="${success}" class="alert alert-success alert-dismissible fade show" role="alert">
                            <span th:text="${success}"></span>
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>

                        <div th:if="${error}" class="alert alert-danger alert-dismissible fade show" role="alert">
                            <span th:text="${error}"></span>
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>

                        <form action="/comments/add" method="post" th:object="${commentReplyDTO}">
                            <h4>Post Comment</h4>
                            <p>Share your thoughts about this post</p>

                            <input type="hidden" th:field="*{post.postID}" th:value="${post.postID}">

                            <div class="row">
                                <div class="col form-group">
                                    <textarea th:field="*{content}" class="form-control" placeholder="Your Comment*"
                                              rows="5" required></textarea>
                                </div>
                            </div>

                            <div class="text-center">
                                <button type="submit" class="btn btn-primary">Post Comment</button>
                            </div>
                        </form>
                    </div>
                </section><!-- /Comment Form Section -->

            </div>

            <div class="col-lg-4 sidebar">

                <div class="widgets-container">
                    <!-- Search Widget -->
                    <div class="search-widget widget-item">

                        <h3 class="widget-title">Search</h3>
                        <form th:action="@{/search}">
                            <input name="search" type="text">
                            <button type="submit" title="Search"><i class="bi bi-search"></i></button>
                        </form>

                    </div><!--/Search Widget -->

                    <!-- Recent Posts Widget -->
                    <div class="recent-posts-widget widget-item">
                        <h3 class="widget-title">Related Posts</h3>

                        <div class="post-item" th:each="relatedPost : ${relatedPosts}">
                            <img th:src="@{${relatedPost.imageUrl}}" alt="" class="flex-shrink-0">
                            <div>
                                <a th:href="@{'/PostDetail/' + ${relatedPost.postID}}"
                                   th:text="${relatedPost.title}"></a>
                                <time th:text="${#dates.format(relatedPost.publishedAt, 'dd MMM yyyy')}"></time>
                            </div>
                        </div><!-- End recent post item-->
                    </div>

                    <!-- Tags Widget -->
                    <div class="tags-widget widget-item">
                        <h3 class="widget-title">Tags</h3>
                        <ul>
                            <li th:each="tag : ${allTags}">
                                <a th:href="@{'/tags/' + ${tag.tagID}}" th:text="${tag.tagName}">Tag</a>
                            </li>
                        </ul>
                    </div>

                </div>

            </div>

        </div>
    </div>



    <!-- Chat Modal -->
    <div class="modal fade" id="chatModal" tabindex="-1" aria-labelledby="chatModalLabel" aria-hidden="true"
         style="position: fixed; bottom: 0; right: 60px; left: auto; z-index: 1055; width: 100%; max-width: 400px; margin: 0; pointer-events: none;">
        <div class="modal-dialog modal-lg m-0"
             style="position: absolute; bottom: 0; right: 0; left: auto; width: 100%; max-width: 400px; margin: 0; pointer-events: auto; transform: none;">
            <div class="modal-content" style="border-radius: 1rem 1rem 0 0; box-shadow: 0 0 20px rgba(0,0,0,0.15);">
                <div class="modal-header bg-primary text-white rounded-top">
                    <h5 class="modal-title" id="chatModalLabel">
                        <i class="bi bi-chat-dots me-2"></i>Chat with <span id="chatPartnerName" class="fw-bold"></span>
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                            aria-label="Close"></button>
                </div>
                <div class="modal-body p-0">
                    <div id="chatMessages" class="chat-messages bg-light"
                         style="height: 350px; overflow-y: auto; border-bottom: 1px solid #ddd; padding: 20px;">
                        <!-- Messages will be loaded here -->
                    </div>
                    <div class="input-group p-3 bg-white border-top align-items-center"
                         style="border-radius: 0 0 1rem 1rem;">
                        <input type="text" id="messageInput" class="form-control rounded-pill me-2"
                               placeholder="Type your message..." maxlength="500" style="background: #f8f9fa;">
                        <button class="btn btn-primary rounded-circle d-flex align-items-center justify-content-center"
                                type="button" id="sendMessageBtn" style="width: 45px; height: 45px;">
                            <i class="bi bi-send fs-5"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>


    </div>

    <!-- WebSocket and Chat JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>

    <script>
        let stompClient = null;
        let currentChatUserId = null;
        let currentUsername = null;
        let currentUserId = null;

        // Get current username from authentication
        document.addEventListener('DOMContentLoaded', function () {
            connect();
            // Get username from server-side
            fetch('/api/user/current')
                .then(response => response.json())
                .then(data => {
                    console.log('Current user data11111:', data);
                    currentUsername = data.username;
                    currentUserId = data.userId;
                    console.log('Current user ID:', currentUserId);
                    console.log('Current username:', currentUsername);
                })
                .catch(error => {
                    console.error('Error getting current user:', error);
                });
        });

        function connect() {
            const socket = new SockJS('/ws');
            stompClient = Stomp.over(socket);

            stompClient.connect({}, function (frame) {
                console.log('Connected: ' + frame);

                // Subscribe to private messages
                stompClient.subscribe('/user/queue/messages', function (message) {
                    const messageData = JSON.parse(message.body);
                    console.log('Received message:', messageData);
                    displayMessage(messageData);
                });
            }, function (error) {
                console.error('WebSocket connection error:', error);
            });
        }

        function disconnect() {
            if (stompClient !== null) {
                stompClient.disconnect();
            }
            console.log("Disconnected");
        }

        function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const content = messageInput.value.trim();

            if (content && currentChatUserId && currentUserId && stompClient) {
                const messageData = {
                    senderId: currentUserId,
                    receiverId: currentChatUserId,
                    content: content
                };
                console.log('=== SENDING MESSAGE ===');
                console.log('Connected:', stompClient.connected);
                console.log('Current chat user ID:', currentChatUserId);
                console.log('Current user ID:', currentUserId);
                console.log('Message data:', messageData);

                if (stompClient.connected) {
                    stompClient.send("/app/chat.sendMessage", {}, JSON.stringify(messageData));
                    messageInput.value = '';
                    console.log('Message sent successfully');
                } else {
                    console.error('WebSocket not connected!');
                }
            } else {
                console.log('Cannot send message:', {
                    content: !!content,
                    currentChatUserId: !!currentChatUserId,
                    currentUserId: !!currentUserId,
                    stompClient: !!stompClient
                });
            }
        }

        function displayMessage(message) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message mb-2';

            // Use senderId for comparison instead of username
            const isCurrentUser = message.senderId === currentUserId;
            const alignClass = isCurrentUser ? 'text-end' : 'text-start';
            const bgClass = isCurrentUser ? 'bg-primary text-white' : 'bg-light';

            messageDiv.innerHTML = `
        <div class="${alignClass}">
            <div class="d-inline-block p-2 rounded ${bgClass}" style="max-width: 70%;">
                <div class="message-content">${escapeHtml(message.content)}</div>
                <small class="message-time">${formatTime(message.createdAt)}</small>
            </div>
        </div>
    `;

            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function loadChatHistory(userId) {
            fetch(`/api/chat/messages/${userId}`)
                .then(response => response.json())
                .then(messages => {
                    const chatMessages = document.getElementById('chatMessages');
                    chatMessages.innerHTML = '';

                    messages.forEach(message => {
                        displayMessage(message);
                    });
                })
                .catch(error => {
                    console.error('Error loading chat history:', error);
                });
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatTime(dateTime) {
            const date = new Date(dateTime);
            return date.toLocaleTimeString('vi-VN', {
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', function () {
            const chatBtn = document.getElementById('chatWithAuthorBtn');
            const chatModal = new bootstrap.Modal(document.getElementById('chatModal'));
            const sendBtn = document.getElementById('sendMessageBtn');
            const messageInput = document.getElementById('messageInput');

            if (chatBtn) {
                chatBtn.addEventListener('click', function () {
                    const authorId = this.getAttribute('data-author-id');
                    const authorName = this.getAttribute('data-author-name');

                    currentChatUserId = parseInt(authorId);
                    document.getElementById('chatPartnerName').textContent = authorName;

                    // Connect to WebSocket if not connected
                    if (!stompClient || !stompClient.connected) {
                        connect();
                    }

                    // Load chat history
                    loadChatHistory(authorId);

                    // Show modal
                    chatModal.show();
                });
            }

            if (sendBtn) {
                sendBtn.addEventListener('click', sendMessage);
            }

            if (messageInput) {
                messageInput.addEventListener('keypress', function (e) {
                    if (e.key === 'Enter') {
                        sendMessage();
                    }
                });
            }

            const favoriteBtn = document.getElementById('favoriteBtn');
            if (favoriteBtn) {
                favoriteBtn.addEventListener('click', function () {
                    const postId = this.getAttribute('data-post-id');
                    const btn = this;

                    // Disable button during request
                    btn.disabled = true;

                    fetch(`/favorites/toggle/${postId}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Requested-With': 'XMLHttpRequest'
                        }
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                // Update button appearance
                                const icon = btn.querySelector('i');
                                const span = btn.querySelector('span');

                                if (data.isFavorited) {
                                    // Post is now favorited
                                    btn.className = 'btn btn-danger';
                                    icon.className = 'bi bi-heart-fill';
                                    span.textContent = 'Đã lưu';
                                } else {
                                    // Post is no longer favorited
                                    btn.className = 'btn btn-outline-danger';
                                    icon.className = 'bi bi-heart';
                                    span.textContent = 'Lưu bài viết';
                                }

                                // Show success message (optional)
                                showToast(data.message, 'success');
                            } else {
                                // Show error message
                                showToast(data.message || 'Có lỗi xảy ra', 'error');
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            showToast('Có lỗi xảy ra khi lưu bài viết', 'error');
                        })
                        .finally(() => {
                            // Re-enable button
                            btn.disabled = false;
                        });
                });
            }

        });

        // Toast notification function
        function showToast(message, type = 'info') {
            // Create toast element
            const toast = document.createElement('div');
            toast.className = `toast align-items-center text-white bg-${type === 'success' ? 'success' : 'danger'} border-0`;
            toast.setAttribute('role', 'alert');
            toast.setAttribute('aria-live', 'assertive');
            toast.setAttribute('aria-atomic', 'true');
            toast.style.position = 'fixed';
            toast.style.top = '20px';
            toast.style.right = '20px';
            toast.style.zIndex = '9999';

            toast.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">
                        ${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            `;

            document.body.appendChild(toast);

            // Initialize and show toast
            const bsToast = new bootstrap.Toast(toast, {
                autohide: true,
                delay: 3000
            });
            bsToast.show();

            // Remove toast element after it's hidden
            toast.addEventListener('hidden.bs.toast', function () {
                document.body.removeChild(toast);
            });
        }

        // Disconnect when page unloads
        window.addEventListener('beforeunload', function () {
            disconnect();
        });
    </script>
</main>

<footer id="footer" class="footer dark-background">


    <div class="container copyright text-center mt-4">
        <p> 2024 <span>Copyright</span> <strong class="px-1 sitename">PersonalBlog</strong>
            <span>All Rights Reserved</span>
        </p>
    </div>

</footer>

<!-- Scroll Top -->
<a href="#" id="scroll-top" class="scroll-top d-flex align-items-center justify-content-center"><i
        class="bi bi-arrow-up-short"></i></a>

<!-- Preloader -->
<div id="preloader"></div>

<script th:src="@{/assets/vendor/bootstrap/js/bootstrap.bundle.min.js}"></script>
<script th:src="@{/assets/vendor/php-email-form/validate.js}"></script>
<script th:src="@{/assets/vendor/aos/aos.js}"></script>
<script th:src="@{/assets/vendor/swiper/swiper-bundle.min.js}"></script>

<!-- Main JS File -->
<script th:src="@{/assets/js/main.js}"></script>

</body>

</html>
